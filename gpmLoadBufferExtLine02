#---Script para carga automática de batches al buffer de producción---
if  newValue.value == 1:
	system.tag.writeBlocking([  "process/dosing/ordersAdmin/gpmExtLine02LoadBatch"],[0])
	logger = system.util.getLogger("ProductionLogs")
	logger.info("Loading ExtLine02 Batch to Execution Buffer")
	extLine = 'EXTLINE02'
	query = 'SELECT bEquipmentId FROM galProdOrderBuffer WHERE destination = ? AND batchBufferNo > 0'
	prodOrderBuffer = system.db.runPrepQuery(query,[extLine])
	mixLine = prodOrderBuffer[0][0]
	counter = prodOrderBuffer.getRowCount()
	if mixLine == 'MIXING01':
		galProdBatchBuffer = 'galProdBatchBuffer01'
		line = 'L1'
	elif mixLine == 'MIXING02':
		galProdBatchBuffer = 'galProdBatchBuffer02'
		line = 'L2'
	query = 'SELECT * FROM galProdOrderBuffer where destination = ? AND bEquipmentId = ?'
	orderData = system.db.runPrepQuery(query,[extLine,mixLine])			
	#Data del buffer de batches
	query = 'SELECT * FROM ' + galProdBatchBuffer
	batchBuffer = system.db.runPrepQuery(query)
	#Data para nuevo batch
	id = orderData.getValueAt(0,0)
	totalBatches = orderData.getValueAt(0,4)
	bufferBatches = orderData.getValueAt(0,6)
	bId = batchBuffer.getRowCount() + 1			
	nextBatch = totalBatches - bufferBatches + 1 #batch to add
	query = "INSERT INTO " + galProdBatchBuffer + " \
								SELECT  ? as bId,\
								moId,\
								orderIndex,\
								finalMatDesc,\
								totalBatches,\
								? as actualBatch,\
								gpmLine,\
								destination\
							FROM galProdOrderBuffer\
							WHERE id = ?"
	args = [bId,nextBatch,id]
	system.db.runPrepUpdate(query,args) #esta linea escribe 2 batchs en el buffer
	logger.info("Prueba baseL2: "+ query) #borrar , esta linea es para ver si se ejecuta el query
	logger.info("Prueba baseL2: "+ str(args)) #borrar , esta linea es para ver los argumentos escritos
	nextBatchPath = 'process/dosing/ordersAdmin/' + line + '/bufferActualBatch' + line
	system.tag.writeBlocking([  nextBatchPath],[nextBatch])
	queryProdOrder = "UPDATE galProdOrderBuffer SET batchBufferNo = batchBufferNo - 1 where id = ?"
	argsProdOrder = [id]
	system.db.runPrepUpdate(queryProdOrder,argsProdOrder)
	#New code for batch planning
	if bufferBatches - 1 == 0:					
		if extLine == 'EXTLINE01' and mixLine == 'MIXING01':
			system.tag.writeAsync(["process/dosing/ordersAdmin/extLine01M1Present"],[0])
			system.tag.writeAsync(["process/dosing/ordersAdmin/extLine01Gpm"],[0])
		elif extLine == 'EXTLINE02' and mixLine == 'MIXING01':
			system.tag.writeAsync(["process/dosing/ordersAdmin/extLine02M1Present"],[0])
			system.tag.writeAsync(["process/dosing/ordersAdmin/extLine02Gpm"],[0])
		elif extLine == 'EXTLINE05' and mixLine == 'MIXING01':
			system.tag.writeAsync(["process/dosing/ordersAdmin/extLine05M1Present"],[0])
			system.tag.writeAsync(["process/dosing/ordersAdmin/extLine05Gpm"],[0])
